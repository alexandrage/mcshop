<?php
namespace McShop\ShoppingCartBundle\Repository;

use Doctrine\ORM\EntityRepository;
use McShop\ShoppingCartBundle\Entity\ShoppingCartCategory;
use Pagerfanta\Adapter\DoctrineORMAdapter;
use Pagerfanta\Pagerfanta;
use Symfony\Component\Form\Form;

/**
 * StorefrontRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ShoppingCartItemRepository extends EntityRepository
{
    /**
     * @param ShoppingCartCategory[]|null $categories
     * @param Form $form
     * @return Pagerfanta
     */
    public function findAllAsPagination(array $categories = [], Form $form = null)
    {
        $qb = $this->createQueryBuilder('i');
        $qb
            ->select('i, c, s')
            ->leftJoin('i.category', 'c')
            ->innerJoin('i.server', 's')
        ;

        if (count($categories) > 0) {
            $qb->andWhere('i.category IN (:categories)')
                ->setParameter('categories', $categories)
            ;
        }

        if ($form !== null) {
            if ($form->get('server')->getData() !== null) {
                $qb
                    ->andWhere('i.server = :server')
                    ->setParameter('server', $form->get('server')->getData())
                ;
            }

            if ($form->get('type')->getData() !== null) {
                $qb
                    ->andWhere('i.type = :type')
                    ->setParameter('type', $form->get('type')->getData())
                ;
            }

            if ($form->get('priceFrom')->getData() !== null) {
                $qb
                    ->andWhere('i.price >= :priceFrom')
                    ->setParameter('priceFrom', $form->get('priceFrom')->getData())
                ;
            }

            if ($form->get('priceTo')->getData() !== null) {
                $qb
                    ->andWhere('i.price <= :priceTo')
                    ->setParameter('priceTo', $form->get('priceTo')->getData())
                ;
            }

            if ($form->get('amount')->getData() !== null) {
                $qb
                    ->andWhere('i.amount = :amount')
                    ->setParameter('amount', $form->get('amount')->getData())
                ;
            }

            if ($form->get('isSale')->getViewData() !== null) {
                dump($form);
                $qb->andWhere('i.sale > 0');
            }
        }

        $adapter = new DoctrineORMAdapter($qb);
        $pagination = new Pagerfanta($adapter);

        return $pagination;
    }
}
